<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>œüœüœü</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <!-- Librer√≠a para leer archivos Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Librer√≠a para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Librer√≠a para enviar emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <!-- Pantalla de carga mientras se verifica autenticaci√≥n -->
    <div id="auth-loading" class="auth-loading-screen">
        <div class="auth-loading-content">
            <h1>œüœüœü</h1>
            <p>‚è≥ Verificando sesi√≥n...</p>
        </div>
    </div>

    <div class="container" id="app-container" style="display: none;">
        <header>
            <div class="header-top">
                <button class="logout-btn" onclick="cerrarSesion()" title="Cerrar sesi√≥n">üö™ Salir</button>
            </div>
            <h1>œüœüœü</h1>
            <p>Sistema integrado de gesti√≥n de inventario y an√°lisis</p>
            <p class="credit">Creado por RAHG</p>
            <p class="user-info" id="user-email"></p>
        </header>

        <!-- Navegaci√≥n por pesta√±as -->
        <div class="tabs">
            <button class="tab-button active" onclick="cambiarVentana('sku')">SKU</button>
            <button class="tab-button" onclick="cambiarVentana('proveedores')">Proveedores</button>
            <button class="tab-button" onclick="cambiarVentana('stock-actual')">Stock Actual</button>
            <button class="tab-button" onclick="cambiarVentana('consumo')">Consumo</button>
            <button class="tab-button" onclick="cambiarVentana('analisis-ventas')">An√°lisis de Ventas</button>
            <button class="tab-button" onclick="cambiarVentana('analisis-inventario')">An√°lisis de Inventario</button>
            <button class="tab-button" onclick="cambiarVentana('pronostico')">Pron√≥stico</button>
            <button class="tab-button" onclick="cambiarVentana('compras')">Compras</button>
            <button class="tab-button" onclick="cambiarVentana('control-entradas')">Control de Entradas</button>
            <button class="tab-button" onclick="cambiarVentana('sku-por-vencer')">SKU por Vencer</button>
            <button class="tab-button" onclick="cambiarVentana('consolidado')">Consolidado</button>
            <button class="tab-button" onclick="cambiarVentana('ingreso-productos')">Ingreso de Productos</button>
            <button class="tab-button" onclick="cambiarVentana('historial-precios')">Historial de Precios</button>
        </div>

        <!-- Ventana SKU -->
        <div id="sku" class="ventana active">
            <h2>üì¶ SKU - Listado de Productos</h2>
            <div id="loading-sku" class="loading" style="display: none;">‚è≥ Cargando datos...</div>
            <div id="error-sku" class="error" style="display: none;"></div>
            <div id="tableContainer-sku" class="table-container"></div>
        </div>

        <!-- Ventana Proveedores -->
        <div id="proveedores" class="ventana">
            <h2>üè¢ Proveedores</h2>
            <div id="loading-proveedores" class="loading" style="display: none;">‚è≥ Cargando datos...</div>
            <div id="error-proveedores" class="error" style="display: none;"></div>
            <div id="tableContainer-proveedores" class="table-container"></div>
        </div>

        <!-- Ventana Stock Actual -->
        <div id="stock-actual" class="ventana">
            <h2>üìä Stock Actual <span id="skuCountStockActual" class="sku-count" style="margin-left: 15px; display: none;"></span></h2>
            <div id="loading-stock-actual" class="loading" style="display: none;">‚è≥ Cargando datos...</div>
            <div id="error-stock-actual" class="error" style="display: none;"></div>
            <div id="tableContainer-stock-actual" class="table-container"></div>
        </div>

        <!-- Ventana Consolidado -->
        <div id="consolidado" class="ventana">
            <h2>üìë Consolidado - Unificar Archivos</h2>
            <div class="file-upload-section">
                <p>Selecciona 4 archivos Excel para consolidar:</p>
                <input type="file" id="fileInputConsolidado" accept=".xlsx, .xls" multiple>
                <button onclick="consolidarArchivos()">üîÑ Consolidar y Crear BBDD</button>
            </div>
            <div id="loading-consolidado" class="loading" style="display: none;">‚è≥ Procesando archivos...</div>
            <div id="error-consolidado" class="error" style="display: none;"></div>
            <div id="info-consolidado" class="info" style="display: none;"></div>
        </div>

        <!-- Ventana Consumo -->
        <div id="consumo" class="ventana">
            <h2>üìà Consumo</h2>
            <div class="filtros-consumo">
                <label>
                    Agrupaci√≥n:
                    <select id="filtroAgrupacion" onchange="actualizarConsumo()">
                        <option value="anual">Anual</option>
                        <option value="mensual">Mensual</option>
                        <option value="semanal">Semanal</option>
                    </select>
                </label>
                <label>
                    A√±o:
                    <select id="filtroAnio" onchange="actualizarConsumo()">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                    </select>
                </label>
                <span id="skuCountConsumo" class="sku-count"></span>
            </div>
            <div class="filtros-tabla-consumo">
                <label>
                    Filtrar SKU:
                    <input type="text" id="filtroSKUConsumo" placeholder="Buscar SKU..." oninput="filtrarTablaConsumo()">
                </label>
                <label>
                    Filtrar Nombre:
                    <input type="text" id="filtroNombreConsumo" placeholder="Buscar nombre..." oninput="filtrarTablaConsumo()">
                </label>
                <label>
                    Ordenar por:
                    <select id="ordenConsumoColumna" onchange="filtrarTablaConsumo()">
                        <option value="original">Original</option>
                        <option value="sku">SKU</option>
                        <option value="nombre">Nombre</option>
                    </select>
                </label>
                <label>
                    <select id="ordenConsumoDir" onchange="filtrarTablaConsumo()">
                        <option value="asc">A ‚Üí Z</option>
                        <option value="desc">Z ‚Üí A</option>
                    </select>
                </label>
            </div>
            <div id="loading-consumo" class="loading" style="display: none;">‚è≥ Cargando datos...</div>
            <div id="error-consumo" class="error" style="display: none;"></div>
            <div id="tableContainer-consumo" class="table-container"></div>
            <div class="chart-container">
                <div class="chart-options">
                    <label class="chart-toggle"><input type="checkbox" id="toggleTendenciaConsumo" onchange="actualizarConsumo()"> L√≠nea de tendencia</label>
                    <label class="chart-toggle"><input type="checkbox" id="toggleRegresionConsumo" onchange="actualizarConsumo()"> L√≠nea de regresi√≥n</label>
                </div>
                <canvas id="chartConsumo"></canvas>
            </div>
        </div>

        <!-- Ventana An√°lisis de Ventas -->
        <div id="analisis-ventas" class="ventana">
            <h2>üí∞ An√°lisis de Ventas</h2>
            <div class="filtros-ventas">
                <label>
                    Fecha Inicio:
                    <input type="date" id="filtroFechaInicio" onchange="actualizarAnalisisVentas()">
                </label>
                <label>
                    Fecha Fin:
                    <input type="date" id="filtroFechaFin" onchange="actualizarAnalisisVentas()">
                </label>
                <label>
                    Vendedor:
                    <select id="filtroVendedor" onchange="actualizarAnalisisVentas()">
                        <option value="">Todos</option>
                    </select>
                </label>
                <span id="skuCountVentas" class="sku-count"></span>
            </div>
            <div id="loading-analisis-ventas" class="loading" style="display: none;">‚è≥ Cargando datos...</div>
            <div id="error-analisis-ventas" class="error" style="display: none;"></div>
            <div id="tableContainer-analisis-ventas" class="table-container"></div>
            <div class="chart-container chart-ventas-container">
                <div class="chart-actions-bar">
                    <button class="btn-descargar-data" onclick="descargarDataAnalisis()">üì• Descargar Data</button>
                </div>
                <canvas id="chartVentas"></canvas>
            </div>
            <div class="chart-container chart-ventas-container">
                <canvas id="chartVentasTotal"></canvas>
            </div>
        </div>

        <!-- Ventana An√°lisis de Inventario -->
        <div id="analisis-inventario" class="ventana">
            <h2>&#128230; An√°lisis de Inventario</h2>

            <!-- Filtro de fechas -->
            <div class="inv-date-filter">
                <label>Desde: <input type="date" id="invFechaInicio" value="2025-01-01"></label>
                <label>Hasta: <input type="date" id="invFechaFin"></label>
                <button onclick="aplicarFiltroFechaInventario()">&#128269; Aplicar filtro</button>
            </div>

            <!-- KPI Cards -->
            <div class="inv-kpi-container" id="inv-kpi-container" style="display:none;">
                <div class="inv-kpi-card">
                    <div class="inv-kpi-label">Total SKUs</div>
                    <div class="inv-kpi-value" id="kpi-total-skus">0</div>
                </div>
                <div class="inv-kpi-card kpi-a">
                    <div class="inv-kpi-label">Clase A</div>
                    <div class="inv-kpi-value" id="kpi-clase-a">0</div>
                    <div class="inv-kpi-detail" id="kpi-clase-a-pct">0% del valor</div>
                </div>
                <div class="inv-kpi-card kpi-b">
                    <div class="inv-kpi-label">Clase B</div>
                    <div class="inv-kpi-value" id="kpi-clase-b">0</div>
                    <div class="inv-kpi-detail" id="kpi-clase-b-pct">0% del valor</div>
                </div>
                <div class="inv-kpi-card kpi-c">
                    <div class="inv-kpi-label">Clase C</div>
                    <div class="inv-kpi-value" id="kpi-clase-c">0</div>
                    <div class="inv-kpi-detail" id="kpi-clase-c-pct">0% del valor</div>
                </div>
                <div class="inv-kpi-card">
                    <div class="inv-kpi-label">Valor Total Ventas</div>
                    <div class="inv-kpi-value" id="kpi-valor-total">$0</div>
                </div>
            </div>

            <!-- Secci√≥n ABC -->
            <div class="inv-section">
                <h3>&#128202; Clasificaci√≥n ABC</h3>
                <p class="inv-desc">Clasificaci√≥n basada en el principio de Pareto (80/15/5): los productos Clase A representan el 80% del valor de ventas, Clase B el siguiente 15%, y Clase C el 5% restante.</p>
                <div class="inv-chart-row">
                    <div class="inv-chart-box">
                        <canvas id="chartABC_pie"></canvas>
                    </div>
                    <div class="inv-chart-box">
                        <canvas id="chartABC_pareto"></canvas>
                    </div>
                </div>
                <div class="inv-filter-bar">
                    <label>Filtrar clase:
                        <select id="filtroClaseABC" onchange="filtrarTablaABC()">
                            <option value="todas">Todas</option>
                            <option value="A">Clase A</option>
                            <option value="B">Clase B</option>
                            <option value="C">Clase C</option>
                        </select>
                    </label>
                    <label>Buscar SKU:
                        <input type="text" id="filtroSKU_ABC" placeholder="SKU..." oninput="filtrarTablaABC()">
                    </label>
                    <label>Buscar Nombre:
                        <input type="text" id="filtroNombre_ABC" placeholder="Nombre..." oninput="filtrarTablaABC()">
                    </label>
                    <button class="btn-exportar-inv" onclick="exportarABC()">&#128229; Exportar ABC a Excel</button>
                </div>
                <div id="tableContainer-abc" class="table-container inv-table-scroll"></div>
            </div>

            <!-- Secci√≥n Rotaci√≥n -->
            <div class="inv-section">
                <h3>&#128260; An√°lisis de Rotaci√≥n de Inventario</h3>
                <p class="inv-desc">Indicadores de rotaci√≥n: √çndice de Rotaci√≥n (ventas / stock), D√≠as de Inventario (stock / consumo diario), y Cobertura en semanas. Productos con alta rotaci√≥n requieren reposici√≥n frecuente; baja rotaci√≥n indica sobrestock o baja demanda.</p>
                <div class="inv-chart-row">
                    <div class="inv-chart-box-full">
                        <canvas id="chartRotacion"></canvas>
                    </div>
                </div>
                <div class="inv-filter-bar">
                    <label>Filtrar rotaci√≥n:
                        <select id="filtroRotacion" onchange="filtrarTablaRotacion()">
                            <option value="todas">Todas</option>
                            <option value="alta">Alta Rotaci√≥n (>12)</option>
                            <option value="media">Media Rotaci√≥n (4-12)</option>
                            <option value="baja">Baja Rotaci√≥n (1-4)</option>
                            <option value="muybaja">Muy Baja / Sin Rotaci√≥n (&lt;1)</option>
                        </select>
                    </label>
                    <label>Buscar SKU:
                        <input type="text" id="filtroSKU_Rot" placeholder="SKU..." oninput="filtrarTablaRotacion()">
                    </label>
                    <label>Buscar Nombre:
                        <input type="text" id="filtroNombre_Rot" placeholder="Nombre..." oninput="filtrarTablaRotacion()">
                    </label>
                    <button class="btn-exportar-inv" onclick="exportarRotacion()">&#128229; Exportar Rotaci√≥n a Excel</button>
                </div>
                <div id="tableContainer-rotacion" class="table-container inv-table-scroll"></div>
            </div>

            <!-- Conclusiones -->
            <div class="inv-insight-box conclusiones" id="inv-conclusiones" style="display:none;">
                <h3>&#128161; Conclusiones Importantes</h3>
                <ul id="inv-conclusiones-lista"></ul>
            </div>

            <!-- Mejoras -->
            <div class="inv-insight-box mejoras" id="inv-mejoras" style="display:none;">
                <h3>&#128640; Mejoras Propuestas</h3>
                <ul id="inv-mejoras-lista"></ul>
            </div>

            <div id="loading-inventario" class="loading" style="display: none;">&#9203; Cargando an√°lisis de inventario...</div>
            <div id="error-inventario" class="error" style="display: none;"></div>
        </div>

        <!-- Ventana Pron√≥stico -->
        <div id="pronostico" class="ventana">
            <h2>üîÆ Pron√≥stico</h2>
            <div class="filtros-pronostico">
                <label>
                    A√±o:
                    <select id="filtroAnioPronostico" onchange="actualizarPronostico()">
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </label>
                <span id="skuCountPronostico" class="sku-count"></span>
            </div>
            <div class="filtros-tabla-consumo">
                <label>
                    Filtrar SKU:
                    <input type="text" id="filtroSKUPronostico" placeholder="Buscar SKU..." oninput="filtrarTablaPronostico()">
                </label>
                <label>
                    Filtrar Producto:
                    <input type="text" id="filtroProductoPronostico" placeholder="Buscar producto..." oninput="filtrarTablaPronostico()">
                </label>
            </div>
            <div id="loading-pronostico" class="loading" style="display: none;">‚è≥ Calculando pron√≥stico...</div>
            <div id="error-pronostico" class="error" style="display: none;"></div>
            <h3 class="pronostico-seccion-titulo">&#128198; Semanal</h3>
            <div id="tableContainer-pronostico-semanal" class="table-container"></div>
            <h3 class="pronostico-seccion-titulo">üìÖ Mensual</h3>
            <div id="tableContainer-pronostico-mensual" class="table-container"></div>
        </div>

        <!-- Ventana Compras -->
        <div id="compras" class="ventana">
            <h2>üõí Compras</h2>
            <div class="filtros-tabla-consumo">
                <div class="filtro-grupo">
                    <label for="filtroAnioCompras">A√±o:</label>
                    <select id="filtroAnioCompras" onchange="actualizarCompras()">
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="filtro-grupo">
                    <label for="filtroSemanaCompras">Semana:</label>
                    <select id="filtroSemanaCompras" onchange="renderizarTablaCompras()">
                    </select>
                </div>
            </div>
            <div id="loading-compras" class="loading" style="display: none;">‚è≥ Cargando datos...</div>
            <div id="error-compras" class="error" style="display: none;"></div>
            <div id="info-semana-compras" class="info-semana" style="margin: 10px 0; font-weight: bold; color: #555;"></div>
            <div id="tableContainer-compras" class="table-container"></div>
            <div id="compras-descarga-wrapper"></div>
        </div>

        <!-- Ventana Control de Entradas -->
        <div id="control-entradas" class="ventana">
            <h2>üìã Control de Entradas</h2>
            <div class="entradas-toolbar">
                <div class="entradas-vista-toggle">
                    <button class="btn-vista active" id="btnVistaSemanal" onclick="cambiarVistaEntradas('semanal')">üìÖ Semanal</button>
                    <button class="btn-vista" id="btnVistaDiaria" onclick="cambiarVistaEntradas('diaria')">üìÜ Diaria</button>
                </div>
                <div class="entradas-nav">
                    <button class="btn-nav" onclick="navegarEntradas(-1)">‚óÄ</button>
                    <span id="entradas-periodo-label" class="entradas-periodo-label"></span>
                    <button class="btn-nav" onclick="navegarEntradas(1)">‚ñ∂</button>
                    <button class="btn-nav-hoy" onclick="navegarEntradasHoy()">Hoy</button>
                </div>
                <button class="btn-agregar-entrada" onclick="abrirModalEntrada()">‚ûï Agendar Entrada</button>
                <button class="btn-carga-masiva" onclick="abrirModalCargaMasiva()">üìã Carga Masiva</button>
            </div>
            <div class="entradas-busqueda">
                <input type="text" id="buscarProductoEntrada" placeholder="üîç Buscar por SKU o nombre de producto..." oninput="buscarProductoEnEntradas()">
                <div id="resultado-busqueda-entrada" class="resultado-busqueda-entrada" style="display:none;"></div>
            </div>
            <div id="entradas-resumen" class="entradas-resumen"></div>
            <div id="entradas-contenido" class="entradas-contenido"></div>

            <!-- Modal para agregar/editar entrada -->
            <div id="modal-entrada" class="modal-overlay" style="display:none;">
                <div class="modal-entrada-box">
                    <h3 id="modal-entrada-titulo">Agendar Entrada</h3>
                    <div class="modal-form">
                        <div class="modal-form-row">
                            <label>Fecha esperada:
                                <input type="date" id="inputFechaEntrada">
                            </label>
                            <label>Proveedor:
                                <select id="inputProveedorEntrada"><option value="">Seleccione...</option></select>
                            </label>
                        </div>
                        <div class="modal-form-row">
                            <label>SKU:
                                <input type="text" id="inputSKUEntrada" placeholder="C√≥digo SKU" oninput="autocompletarSKUEntrada()">
                            </label>
                            <label>Producto:
                                <input type="text" id="inputProductoEntrada" readonly>
                            </label>
                        </div>
                        <div class="modal-form-row">
                            <label>Cantidad esperada:
                                <input type="number" id="inputCantidadEntrada" min="1" placeholder="0">
                            </label>
                            <label>Nota (opcional):
                                <input type="text" id="inputNotaEntrada" placeholder="Observaciones...">
                            </label>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-modal-guardar" onclick="guardarEntrada()">üíæ Guardar</button>
                        <button class="btn-modal-cancelar" onclick="cerrarModalEntrada()">Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Modal para carga masiva -->
            <div id="modal-carga-masiva" class="modal-overlay" style="display:none;">
                <div class="modal-entrada-box modal-masiva-box">
                    <h3>üìã Carga Masiva de Entradas</h3>
                    <div class="modal-form">
                        <div class="modal-form-row">
                            <label>Fecha esperada:
                                <input type="date" id="inputFechaMasiva">
                            </label>
                            <label>Proveedor:
                                <select id="inputProveedorMasiva"><option value="">Seleccione...</option></select>
                            </label>
                        </div>
                        <label class="masiva-textarea-label">Pegar lista de productos:
                            <textarea id="inputTextoMasivo" rows="10" placeholder="Formato por l√≠nea:&#10;235008&#9;TABLA DE QUESO DEGUSTACION... - 3 CAJAS&#10;229001&#9;QUESO PROVOLETA... - 15 UNIDADES"></textarea>
                        </label>
                        <div id="masiva-preview" class="masiva-preview"></div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-modal-preview" onclick="previsualizarCargaMasiva()">üîç Previsualizar</button>
                        <button class="btn-modal-guardar" onclick="guardarCargaMasiva()">üíæ Agendar todos</button>
                        <button class="btn-modal-cancelar" onclick="cerrarModalCargaMasiva()">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ventana SKU por Vencer -->
        <div id="sku-por-vencer" class="ventana">
            <h2>&#9888;&#65039; SKU por Vencer</h2>
            <p class="inv-desc">Productos no bloqueados cuya fecha de vencimiento se aproxima. Usa el filtro de fecha l√≠mite para identificar lotes que vencer√°n antes de esa fecha.</p>

            <div class="inv-date-filter">
                <label>Fecha l√≠mite: <input type="date" id="vencerFechaLimite"></label>
                <button onclick="aplicarFiltroVencer()">&#128269; Filtrar</button>
                <button class="btn-exportar-inv" onclick="exportarSKUporVencer()">&#128229; Exportar a Excel</button>
            </div>

            <div class="vencer-resumen" id="vencer-resumen" style="display:none;">
                <span class="vencer-count" id="vencer-count">0 productos</span>
            </div>

            <div id="tableContainer-vencer" class="table-container"></div>

            <div id="loading-vencer" class="loading" style="display: none;">&#9203; Cargando Stock Valorizado...</div>
            <div id="error-vencer" class="error" style="display: none;"></div>
        </div>

        <div id="ingreso-productos" class="ventana">
            <h2>‚úçÔ∏è Ingreso de Productos</h2>
            
            <div class="form-ingreso">
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputRut">RUT:</label>
                        <input type="text" id="inputRut" oninput="formatearRUT(this)" maxlength="12" placeholder="12.345.678-9">
                    </div>
                    <div class="form-group">
                        <label for="inputComercializadora">COMERCIALIZADORA:</label>
                        <input type="text" id="inputComercializadora" readonly>
                    </div>
                    <div class="form-group">
                        <label for="inputFactura">FACTURA:</label>
                        <input type="text" id="inputFactura">
                    </div>
                </div>

                <div class="productos-table-container">
                    <table id="tablaProductos" class="productos-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Total Neto</th>
                                <th>Costo Unitario Neto</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="productosBody">
                            <tr>
                                <td><input type="text" class="input-sku" onblur="autocompletarProducto(this)"></td>
                                <td><input type="text" class="input-producto" readonly></td>
                                <td><input type="number" class="input-cantidad" oninput="calcularCostoUnitario(this)"></td>
                                <td><input type="text" class="input-total-neto" oninput="formatearTotalNeto(this); calcularCostoUnitario(this)"></td>
                                <td><input type="text" class="input-costo-unitario" readonly></td>
                                <td><button class="btn-eliminar" onclick="eliminarFila(this)">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-actions">
                    <button class="btn-agregar-fila" onclick="agregarFilaProducto()">‚ûï Agregar fila</button>
                    <button class="btn-enviar-correo" onclick="enviarCorreo()">üìß Enviar correo</button>
                </div>
            </div>

            <div id="loading-ingreso" class="loading" style="display: none;">‚è≥ Enviando correo...</div>
            <div id="error-ingreso" class="error" style="display: none;"></div>
            <div id="success-ingreso" class="success" style="display: none;"></div>
        </div>

        <!-- Ventana Historial de Precios -->
        <div id="historial-precios" class="ventana">
            <h2>&#128181; Historial de Precios</h2>

            <div class="form-historial">
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputSKUHistorial">SKU:</label>
                        <input type="text" id="inputSKUHistorial" placeholder="Ingrese SKU" oninput="autocompletarNombreHistorial()">
                    </div>
                    <div class="form-group">
                        <label for="inputNombreHistorial">Nombre:</label>
                        <input type="text" id="inputNombreHistorial" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputRutHistorial">Rut Proveedor:</label>
                        <input type="text" id="inputRutHistorial" oninput="formatearRUTHistorial(this)" maxlength="12" placeholder="12.345.678-9">
                    </div>
                    <div class="form-group">
                        <label for="inputNombreProvHistorial">Nombre Proveedor:</label>
                        <input type="text" id="inputNombreProvHistorial" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="inputPrecioHistorial">Precio:</label>
                        <input type="text" id="inputPrecioHistorial" placeholder="$0" oninput="formatearPrecioHistorial(this)">
                    </div>
                    <div class="form-group">
                        <label for="inputFechaHistorial">Fecha:</label>
                        <input type="date" id="inputFechaHistorial">
                    </div>
                </div>
                <div class="form-actions-historial">
                    <button class="btn-ingresar-registro" onclick="ingresarRegistroHistorial()" id="btnIngresarHistorial">&#128229; Ingresar registro</button>
                    <span id="archivo-vinculado" class="archivo-vinculado"></span>
                </div>
            </div>

            <div id="loading-historial" class="loading" style="display: none;">&#9203; Procesando...</div>
            <div id="error-historial" class="error" style="display: none;"></div>
            <div id="success-historial" class="success" style="display: none;"></div>

            <h3 style="margin-top: 20px;">Registros actuales</h3>
            <div id="tableContainer-historial" class="table-container"></div>
        </div>

    </div>

    <script src="script.js"></script>
    <script>
        // === PROTECCI√ìN DE AUTENTICACI√ìN ===
        firebase.auth().onAuthStateChanged(function(user) {
            const loadingScreen = document.getElementById('auth-loading');
            const appContainer = document.getElementById('app-container');

            if (user) {
                // Usuario autenticado - mostrar la app
                loadingScreen.style.display = 'none';
                appContainer.style.display = 'block';
                document.getElementById('user-email').textContent = 'üë§ ' + user.email;
            } else {
                // No autenticado - redirigir al login
                window.location.href = 'login.html';
            }
        });

        function cerrarSesion() {
            if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
                firebase.auth().signOut().then(function() {
                    window.location.href = 'login.html';
                });
            }
        }
    </script>
</body>
</html>
